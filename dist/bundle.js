(()=>{"use strict";let t=()=>{};let e,i,s={};function n(t,...e){(s[t]||[]).map((t=>t(...e)))}let h={get:(e,i)=>"_proxy"==i||t};function a(){return i}class r{constructor({spriteSheet:t,frames:e,frameRate:i,loop:s=!0}){this.spriteSheet=t,this.frames=e,this.frameRate=i,this.loop=s;let{width:n,height:h,margin:a=0}=t.frame;this.width=n,this.height=h,this.margin=a,this._f=0,this._a=0}clone(){return new r(this)}reset(){this._f=0,this._a=0}update(t=1/60){if(this.loop||this._f!=this.frames.length-1)for(this._a+=t;this._a*this.frameRate>=1;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate}render({x:t,y:e,width:i=this.width,height:s=this.height,context:n=a()}){let h=this.frames[this._f]/this.spriteSheet._f|0,r=this.frames[this._f]%this.spriteSheet._f|0;n.drawImage(this.spriteSheet.image,r*this.width+(2*r+1)*this.margin,h*this.height+(2*h+1)*this.margin,this.width,this.height,t,e,i,s)}}function o(){return new r(...arguments)}let c=/^\//,d=/\/$/,l=new WeakMap,u="";function w(t,e){return new URL(t,e).href}let p={},f={};function g(t){return window.__k||(window.__k={dm:l,u:w,d:f,i:p}),new Promise(((e,i)=>{let s,h,a;if(s=function(t,e){return[t.replace(d,""),t?e.replace(c,""):e].filter((t=>t)).join("/")}(u,t),p[s])return e(p[s]);h=new Image,h.onload=function(){a=w(s,window.location.href),p[function(t){let e=t.replace("."+function(t){return t.split(".").pop()}(t),"");return 2==e.split("/").length?e.replace(c,""):e}(t)]=p[s]=p[a]=this,n("assetLoaded",this,t),e(this)},h.onerror=function(){i("Unable to load image "+s)},h.src=s}))}function m(t,e,i){return Math.min(Math.max(t,i),e)}class x{constructor(t=0,e=0,i={}){this.x=t,this.y=e,i._c&&(this.clamp(i._a,i._b,i._d,i._e),this.x=t,this.y=e)}add(t){return new x(this.x+t.x,this.y+t.y,this)}subtract(t){return new x(this.x-t.x,this.y-t.y,this)}scale(t){return new x(this.x*t,this.y*t)}normalize(t=this.length()){return new x(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}length(){return Math.hypot(this.x,this.y)}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}angle(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}clamp(t,e,i,s){this._c=!0,this._a=t,this._b=e,this._d=i,this._e=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?m(this._a,this._d,t):t}set y(t){this._y=this._c?m(this._b,this._e,t):t}}function y(){return new x(...arguments)}class _ extends class extends class{constructor(t){return this.init(t)}init(t={}){this.position=y(),this.velocity=y(),this.acceleration=y(),this.ttl=1/0,Object.assign(this,t)}update(t){this.advance(t)}advance(t){let e=this.acceleration;t&&(e=e.scale(t)),this.velocity=this.velocity.add(e);let i=this.velocity;t&&(i=i.scale(t)),this.position=this.position.add(i),this._pc(),this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return this.ttl>0}_pc(){}}{init({width:t=0,height:e=0,context:i=a(),render:s=this.draw,update:n=this.advance,children:h=[],anchor:r={x:0,y:0},opacity:o=1,rotation:c=0,scaleX:d=1,scaleY:l=1,...u}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:r,opacity:o,rotation:c,scaleX:d,scaleY:l,...u}),this._di=!0,this._uw(),this.addChild(h),this._rf=s,this._uf=n}update(t){this._uf(t),this.children.map((e=>e.update&&e.update(t)))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),this.rotation&&t.rotate(this.rotation),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY);let e=-this.width*this.anchor.x,i=-this.height*this.anchor.y;(e||i)&&t.translate(e,i),this.context.globalAlpha=this.opacity,this._rf(),(e||i)&&t.translate(-e,-i),this.children.map((t=>t.render&&t.render())),t.restore()}draw(){}_pc(){this._uw(),this.children.map((t=>t._pc()))}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wo:i=1,_wr:s=0,_wsx:n=1,_wsy:h=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this._wo=i*this.opacity,this._wsx=n*this.scaleX,this._wsy=h*this.scaleY,this._wx=this._wx*n,this._wy=this._wy*h,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this._wr=s+this.rotation;let{x:a,y:r}=function(t,e){let i=Math.sin(e),s=Math.cos(e);return{x:t.x*s-t.y*i,y:t.x*i+t.y*s}}({x:this._wx,y:this._wy},s);this._wx=a,this._wy=r,this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,opacity:this._wo,rotation:this._wr,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...e){e.flat().map((e=>{this.children.push(e),e.parent=this,e._pc=e._pc||t,e._pc()}))}removeChild(...t){t.flat().map((t=>{(function(t,e){let i=t.indexOf(e);if(-1!=i)return t.splice(i,1),!0})(this.children,t)&&(t.parent=null,t._pc())}))}get opacity(){return this._opa}set opacity(t){this._opa=t,this._pc()}get rotation(){return this._rot}set rotation(t){this._rot=t,this._pc()}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}{init({image:t,width:e=(t?t.width:void 0),height:i=(t?t.height:void 0),...s}={}){super.init({image:t,width:e,height:i,...s})}get animations(){return this._a}set animations(t){let e,i;for(e in this._a={},t)this._a[e]=t[e].clone(),i=i||this._a[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}playAnimation(t){this.currentAnimation=this.animations[t],this.currentAnimation.loop||this.currentAnimation.reset()}advance(t){super.advance(t),this.currentAnimation&&this.currentAnimation.update(t)}draw(){this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height),this.currentAnimation&&this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context}),this.color&&(this.context.fillStyle=this.color,this.context.fillRect(0,0,this.width,this.height))}}function v(t){let e=t.canvas;t.clearRect(0,0,e.width,e.height)}new WeakMap;let E=[],S={},A={},b={0:"south",1:"east",2:"west",3:"north",4:"leftshoulder",5:"rightshoulder",6:"lefttrigger",7:"righttrigger",8:"select",9:"start",10:"leftstick",11:"rightstick",12:"dpadup",13:"dpaddown",14:"dpadleft",15:"dpadright"};function k(t){E[t.gamepad.index]={pressedButtons:{},axes:{}}}function P(t){delete E[t.gamepad.index]}function M(){E.map((t=>{t.pressedButtons={},t.axes={}}))}function R(){let t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];for(let e=0;e<t.length;e++){let i=t[e];if(!i)continue;i.buttons.map(((t,e)=>{let s=b[e],{pressed:n}=t,{pressedButtons:h}=E[i.index],a=h[s];!a&&n?[S[i.index],S].map((e=>{e?.[s]?.(i,t)})):a&&!n&&[A[i.index],A].map((e=>{e?.[s]?.(i,t)})),h[s]=n}));let{axes:s}=E[i.index];s.leftstickx=i.axes[0],s.leftsticky=i.axes[1],s.rightstickx=i.axes[2],s.rightsticky=i.axes[3]}}function T(t,{gamepad:e}={}){return isNaN(e)?E.some((e=>e.pressedButtons[t])):!!E[e]&&!!E[e].pressedButtons[t]}let C={},L={},I={},Y={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"arrowleft",ArrowUp:"arrowup",ArrowRight:"arrowright",ArrowDown:"arrowdown"};function z(e=t,i){e._pd&&i.preventDefault(),e(i)}function B(t){let e=Y[t.code],i=C[e];I[e]=!0,z(i,t)}function G(t){let e=Y[t.code],i=L[e];I[e]=!1,z(i,t)}function X(){I={}}function W(t){return!!I[t]}function D(t){if(+t==t)return t;let e=[],i=t.split(".."),s=+i[0],n=+i[1],h=s;if(s<n)for(;h<=n;h++)e.push(h);else for(;h>=n;h--)e.push(h);return e}class F{constructor({image:t,frameWidth:e,frameHeight:i,frameMargin:s,animations:n}={}){if(!t)throw Error("You must provide an Image for the SpriteSheet");this.animations={},this.image=t,this.frame={width:e,height:i,margin:s},this._f=t.width/e|0,this.createAnimations(n)}createAnimations(t){let e,i;for(i in t){let{frames:s,frameRate:n,loop:h}=t[i];if(e=[],null==s)throw Error("Animation "+i+" must provide a frames property");[].concat(s).map((t=>{e=e.concat(D(t))})),this.animations[i]=o({spriteSheet:this,frames:e,frameRate:n,loop:h})}}}function U(){return new F(...arguments)}class O{constructor(t,e,i,s){this.x1=t,this.x2=t+i,this.y1=e,this.y2=e+s,this.width=i,this.height=s}}class ${constructor(t,e,i,s,n,h){this.name=t,this.size=e,this.startPoint=s,this.endPoint=n,this.time=h,this.map=this.setUpMap(i)}setUpMap(t){const e=[];return t.forEach((t=>{e.push(new O(t[0],t[1],t[2],t[3]))})),e}draw(t,e){t.width=this.size,t.height=this.size;const i=t.context;this.map.forEach((t=>{if(t.width>=t.height){for(let s=0;s<Math.floor(t.width/10);s++)i.drawImage(e,t.x1+10*s,t.y1,10,10);t.width%10!=0&&i.drawImage(e,t.x1+10*Math.floor(t.width/10),t.y1,t.width%10,10)}else{for(let s=0;s<Math.floor(t.height/10);s++)i.drawImage(e,t.x1,t.y1+10*s,10,10);t.height%10!=0&&i.drawImage(e,t.x1,t.y1+10*Math.floor(t.height/10),10,t.height%10)}})),i.fillStyle="grey",i.fill()}}const q=[new $(1,128,[[0,6,117,10],[110,6,10,52],[77,48,33,10],[77,34,10,14],[77,34,29,10],[96,20,10,15],[65,20,31,10],[62,20,10,51],[62,63,58,10],[110,63,10,44],[68,97,42,10],[5,113,123,10],[5,19,10,94],[5,19,21,10],[20,19,10,87],[20,97,41,10],[51,80,10,10],[51,84,10,23],[59,80,51,10],[48,16,10,52],[34,58,15,10],[34,19,10,76]],[5,11],[128,118],20),new $(2,128,[[0,60,41,10],[31,31,10,29],[31,31,55,10],[76,31,10,44],[53,65,23,10],[53,65,10,21],[7,76,46,10],[7,112,59,10],[10,23,10,37],[10,13,95,10],[95,14,10,72],[53,86,10,13],[53,89,67,10],[110,51,10,38],[110,51,15,10],[115,51,14,10],[7,86,10,30],[7,106,10,11],[9,112,111,10]],[5,65],[128,55],20)];class N{constructor(t){this.canvas=t,this.context=t.getContext("2d")}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t,e,i,s,n){this.context.drawImage(t,e,i,s,n)}drawText(t){this.context.font=t.font,this.context.fillStyle=t.color;let e=this.context.measureText(t.text).width,i=t.x-e/2;this.context.fillText(t.text,i,t.y)}drawFadingText(t){this.drawText({text:t.text,font:`${t.size}px Arial`,color:`rgba(255, 255, 255, ${t.opacity})`,x:t.position[0],y:t.position[1]})}drawPlayerLight(t,e,i,s){let n=this.canvas.width*(1-s)<=3*i?3*i:this.canvas.width*(1-s),h=i+.1*this.canvas.width*(1-s),a=this.context.createRadialGradient(t,e,h,t,e,n);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(1,"rgba(0, 0, 0, 1)"),this.context.fillStyle=a,this.context.arc(t,e,2*this.canvas.width,0,2*Math.PI),this.context.fill()}drawEndPoint(t,e,i){let s=this.context.createRadialGradient(t,e,0,t,e,2*i);s.addColorStop(0,"rgba(1, 1, 1, 0)"),s.addColorStop(1,"rgba(1, 1, 1, 1)"),this.context.fillStyle=s,this.context.arc(t,e,i,0,2*Math.PI),this.context.fill()}drawYouLooseText(){let t=this.canvas.height/12+"px Arial",e=this.canvas.width/2,i=this.canvas.height/2;this.drawText({text:"Life was never for you...",font:t,color:"white",x:e,y:i})}drawYouWinText(){let t=this.canvas.height/12+"px Arial",e=this.canvas.width/2,i=this.canvas.height/2;this.drawText({text:"You win!",font:t,color:"white",x:e,y:i})}setSize(t){this.canvas.width=t,this.canvas.height=t}}class j{constructor(){this.previousTime=(new Date).getTime()/1e3,this.timeElapsed=0,this.isRunning=!1}tick(){if(this.isRunning){let t=(new Date).getTime()/1e3;if(0!=Math.floor(t-this.previousTime))return this.timeElapsed++,this.previousTime=t,!0}return!1}start(){this.previousTime=(new Date).getTime()/1e3,this.isRunning=!0}reset(){this.timeElapsed=0,this.isRunning=!1}}class H{constructor(t,e,i){this.position=t,this.text=e,this.size=i,this.opacity=1}reduceOpacity(){this.opacity-=.01}}const K=[new H([256,200],'"We need help here stat"',20),new H([75,100],'"Make room"',20),new H([315,64],'"We\'re loosing him"',20),new H([75,412],'"Come on"',20),new H([356,378],'"Time of death..."',20)];let{canvas:J,context:Q}=function(t,{contextless:s=!1}={}){if(e=document.getElementById(t)||t||document.querySelector("canvas"),s&&(e=e||new Proxy({},h)),!e)throw Error("You must provide a canvas element for the game");return i=e.getContext("2d")||new Proxy({},h),i.imageSmoothingEnabled=!1,n("init"),{canvas:e,context:i}}(document.getElementById("kontra"));J.style.backgroundColor="rgba(0, 0, 0, 0)";const V=new N(document.getElementById("background")),Z=new N(document.getElementById("text-layer")),tt=new N(document.getElementById("light-layer"));var et,it;u="./../assets/",function(){let t;for(t=0;t<26;t++)Y["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)Y["Digit"+t]=Y["Numpad"+t]=""+t;window.addEventListener("keydown",B),window.addEventListener("keyup",G),window.addEventListener("blur",X)}(),window.addEventListener("gamepadconnected",k),window.addEventListener("gamepaddisconnected",P),window.addEventListener("blur",M),it=R,s[et="tick"]=s[et]||[],s[et].push(it),function(){const t=[g("wisp-full.png"),g("floor-export.png")];return Promise.all(t)}().then((e=>{let i=0,s=q.length,h=0;const r=function(){return new _(...arguments)}({x:0,y:0,rad:4,animations:new U({image:e[0],frameWidth:16,frameHeight:16,animations:{idle:{frames:"0..3",frameRate:5},death:{frames:"3..7",frameRate:5}}}).animations,speed:1,getPosition:function(){return{x:this.x+8,y:this.y+8}},setPosition:function(t,e){this.x=t-8,this.y=e-8}});r.playAnimation("idle");const o=e[1];y(r),E(o);let c=new H([256,256],`Level ${i}`,50);const d=new j;d.start();const l=new j;let u=0,w=!1,p=!1,f=1/(h-5),g=!1,m=!1,x=function({fps:e=60,clearCanvas:i=!0,update:s=t,render:h,context:r=a(),blur:o=!1}={}){if(!h)throw Error("You must provide a render() function");let c,d,l,u,w,p=0,f=1e3/e,g=1/e,m=i?v:t,x=!0;function y(){if(d=requestAnimationFrame(y),x&&(l=performance.now(),u=l-c,c=l,!(u>1e3))){for(n("tick"),p+=u;p>=f;)w.update(g),p-=f;m(r),w.render()}}return o||(window.addEventListener("focus",(()=>{x=!0})),window.addEventListener("blur",(()=>{x=!1}))),w={update:s,render:h,isStopped:!0,start(){c=performance.now(),this.isStopped=!1,requestAnimationFrame(y)},stop(){this.isStopped=!0,cancelAnimationFrame(d)},_frame:y,set _last(t){c=t}},w}({update:function(){g||(d.tick()&&(d.timeElapsed,d.timeElapsed==h-5&&(p=!0,l.start()),d.timeElapsed==h&&(m=!0,r.playAnimation("death"),w=!0)),m||(function(t,e){const i=t.getPosition(),s=t.rad;return i.x+s>=e[0]-5&&i.x-s<=e[0]+5&&i.y+s>=e[1]-5&&i.y-s<=e[1]+5}(r,q[i].endPoint)&&(i++,i>=s?(i=0,g=!0,d.reset()):(y(r),f=1/(h-5),d.reset(),d.start(),l.reset(),p=!1,c=new H([256,256],"Level "+(i+1),50),E(o))),function(t,e){const i=[0,0];(W(Y.ArrowDown)||T("dpaddown"))&&(i[1]+=1),(W(Y.ArrowUp)||T("dpadup"))&&(i[1]-=1),(W(Y.ArrowLeft)||T("dpadleft"))&&(i[0]-=1),(W(Y.ArrowRight)||T("dpadright"))&&(i[0]+=1),function(t,e,i){const s=t.getPosition(),n=s.x+e[0],h=s.y+e[1];for(let t=0;t<i.length;t++)if(n>=i[t].x1&&n<=i[t].x2&&h>=i[t].y1&&h<=i[t].y2)return!0;return!1}(t,i,e)&&function(t,e){t.x+=e[0],t.y+=e[1]}(t,i)}(r,q[i].map)),r.update())},render:function(){if(g)V.clear(),Z.clear(),Z.drawYouWinText();else if(m)w&&(u++,u<60?(r.render(),tt.clear(),V.clear()):(V.clear(),Z.clear(),Z.drawYouLooseText()));else{!function(t,e){let i=t.createRadialGradient(e[0],e[1],0,e[0],e[1],10);i.addColorStop(0,"rgba(255, 255, 255, 1)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),t.beginPath(),t.arc(e[0],e[1],10,0,2*Math.PI),t.fillStyle=i,t.fill()}(Q,q[i].endPoint),Z.clear(),tt.clear();let t=f*(d.timeElapsed+1)<=1?f*(d.timeElapsed+1):1;tt.drawPlayerLight(r.x+2*r.rad,r.y+2*r.rad,r.rad,t),r.render(),p&&(l.tick(),K.forEach(((t,e)=>{e<=l.timeElapsed&&t.opacity>0&&(Z.drawFadingText(t),t.reduceOpacity())}))),c.opacity&&(Z.drawFadingText(c),c.reduceOpacity())}}});function y(t){h=q[i].time,t.setPosition(q[i].startPoint[0],q[i].startPoint[1]),V.setSize(q[i].size),tt.setSize(q[i].size),J.width=q[i].size,J.height=q[i].size}function E(t){i<=s&&q[i].draw(V,t)}x.start()}))})();