(()=>{"use strict";let t=()=>{};let e,i,n={};function s(t,e){n[t]=n[t]||[],n[t].push(e)}function o(t,...e){(n[t]||[]).map((t=>t(...e)))}let a={get:(e,i)=>"_proxy"==i||t};function r(){return e}function h(){return i}class c{constructor({spriteSheet:t,frames:e,frameRate:i,loop:n=!0}){this.spriteSheet=t,this.frames=e,this.frameRate=i,this.loop=n;let{width:s,height:o,margin:a=0}=t.frame;this.width=s,this.height=o,this.margin=a,this._f=0,this._a=0}clone(){return new c(this)}reset(){this._f=0,this._a=0}update(t=1/60){if(this.loop||this._f!=this.frames.length-1)for(this._a+=t;this._a*this.frameRate>=1;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate}render({x:t,y:e,width:i=this.width,height:n=this.height,context:s=h()}){let o=this.frames[this._f]/this.spriteSheet._f|0,a=this.frames[this._f]%this.spriteSheet._f|0;s.drawImage(this.spriteSheet.image,a*this.width+(2*a+1)*this.margin,o*this.height+(2*o+1)*this.margin,this.width,this.height,t,e,i,n)}}function l(){return new c(...arguments)}let d=/^\//,u=/\/$/,p=new WeakMap,f="";function g(t,e){return new URL(t,e).href}let w={},m={};function x(t){return window.__k||(window.__k={dm:p,u:g,d:m,i:w}),new Promise(((e,i)=>{let n,s,a;if(n=function(t,e){return[t.replace(u,""),t?e.replace(d,""):e].filter((t=>t)).join("/")}(f,t),w[n])return e(w[n]);s=new Image,s.onload=function(){a=g(n,window.location.href),w[function(t){let e=t.replace("."+function(t){return t.split(".").pop()}(t),"");return 2==e.split("/").length?e.replace(d,""):e}(t)]=w[n]=w[a]=this,o("assetLoaded",this,t),e(this)},s.onerror=function(){i("Unable to load image "+n)},s.src=n}))}function y(t,e,i){return Math.min(Math.max(t,i),e)}class _{constructor(t=0,e=0,i={}){this.x=t,this.y=e,i._c&&(this.clamp(i._a,i._b,i._d,i._e),this.x=t,this.y=e)}add(t){return new _(this.x+t.x,this.y+t.y,this)}subtract(t){return new _(this.x-t.x,this.y-t.y,this)}scale(t){return new _(this.x*t,this.y*t)}normalize(t=this.length()){return new _(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}length(){return Math.hypot(this.x,this.y)}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}angle(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}clamp(t,e,i,n){this._c=!0,this._a=t,this._b=e,this._d=i,this._e=n}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?y(this._a,this._d,t):t}set y(t){this._y=this._c?y(this._b,this._e,t):t}}function v(){return new _(...arguments)}class M extends class extends class{constructor(t){return this.init(t)}init(t={}){this.position=v(),this.velocity=v(),this.acceleration=v(),this.ttl=1/0,Object.assign(this,t)}update(t){this.advance(t)}advance(t){let e=this.acceleration;t&&(e=e.scale(t)),this.velocity=this.velocity.add(e);let i=this.velocity;t&&(i=i.scale(t)),this.position=this.position.add(i),this._pc(),this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return this.ttl>0}_pc(){}}{init({width:t=0,height:e=0,context:i=h(),render:n=this.draw,update:s=this.advance,children:o=[],anchor:a={x:0,y:0},opacity:r=1,rotation:c=0,scaleX:l=1,scaleY:d=1,...u}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:a,opacity:r,rotation:c,scaleX:l,scaleY:d,...u}),this._di=!0,this._uw(),this.addChild(o),this._rf=n,this._uf=s}update(t){this._uf(t),this.children.map((e=>e.update&&e.update(t)))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),this.rotation&&t.rotate(this.rotation),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY);let e=-this.width*this.anchor.x,i=-this.height*this.anchor.y;(e||i)&&t.translate(e,i),this.context.globalAlpha=this.opacity,this._rf(),(e||i)&&t.translate(-e,-i),this.children.map((t=>t.render&&t.render())),t.restore()}draw(){}_pc(){this._uw(),this.children.map((t=>t._pc()))}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wo:i=1,_wr:n=0,_wsx:s=1,_wsy:o=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this._wo=i*this.opacity,this._wsx=s*this.scaleX,this._wsy=o*this.scaleY,this._wx=this._wx*s,this._wy=this._wy*o,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this._wr=n+this.rotation;let{x:a,y:r}=function(t,e){let i=Math.sin(e),n=Math.cos(e);return{x:t.x*n-t.y*i,y:t.x*i+t.y*n}}({x:this._wx,y:this._wy},n);this._wx=a,this._wy=r,this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,opacity:this._wo,rotation:this._wr,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...e){e.flat().map((e=>{this.children.push(e),e.parent=this,e._pc=e._pc||t,e._pc()}))}removeChild(...t){t.flat().map((t=>{(function(t,e){let i=t.indexOf(e);if(-1!=i)return t.splice(i,1),!0})(this.children,t)&&(t.parent=null,t._pc())}))}get opacity(){return this._opa}set opacity(t){this._opa=t,this._pc()}get rotation(){return this._rot}set rotation(t){this._rot=t,this._pc()}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}{init({image:t,width:e=(t?t.width:void 0),height:i=(t?t.height:void 0),...n}={}){super.init({image:t,width:e,height:i,...n})}get animations(){return this._a}set animations(t){let e,i;for(e in this._a={},t)this._a[e]=t[e].clone(),i=i||this._a[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}playAnimation(t){this.currentAnimation=this.animations[t],this.currentAnimation.loop||this.currentAnimation.reset()}advance(t){super.advance(t),this.currentAnimation&&this.currentAnimation.update(t)}draw(){this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height),this.currentAnimation&&this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context}),this.color&&(this.context.fillStyle=this.color,this.context.fillRect(0,0,this.width,this.height))}}function b(){return new M(...arguments)}let E=new WeakMap,S={},A={},P={0:"left",1:"middle",2:"right"};function R(t,e){let{x:i,y:n,width:s,height:o}=function(t){let{x:e=0,y:i=0,width:n,height:s}=t.world||t;return t.mapwidth&&(n=t.mapwidth,s=t.mapheight),t.anchor&&(e-=n*t.anchor.x,i-=s*t.anchor.y),n<0&&(e+=n,n*=-1),s<0&&(i+=s,s*=-1),{x:e,y:i,width:n,height:s}}(t);do{i-=t.sx||0,n-=t.sy||0}while(t=t.parent);let a=e.x-Math.max(i,Math.min(e.x,i+s)),r=e.y-Math.max(n,Math.min(e.y,n+o));return a*a+r*r<e.radius*e.radius}function k(t,e){return parseFloat(t.getPropertyValue(e))||0}function C(t){let e=null!=t.button?P[t.button]:"left";A[e]=!0,B(t,"onDown")}function T(t){let e=null!=t.button?P[t.button]:"left";A[e]=!1,B(t,"onUp")}function L(t){B(t,"onOver")}function I(t){E.get(t.target)._oo=null,A={}}function Y(t,e,i){let n=function(t){let e=t._lf.length?t._lf:t._cf;for(let i=e.length-1;i>=0;i--){let n=e[i];if(n.collidesWithPointer?n.collidesWithPointer(t):R(n,t))return n}}(t);n&&n[e]&&n[e](i),S[e]&&S[e](i,n),"onOver"==e&&(n!=t._oo&&t._oo&&t._oo.onOut&&t._oo.onOut(i),t._oo=n)}function B(t,e){t.preventDefault();let i=t.target,n=E.get(i),{scaleX:s,scaleY:a,offsetX:r,offsetY:h}=function(t){let{canvas:e,_s:i}=t,n=e.getBoundingClientRect(),s="none"!=i.transform?i.transform.replace("matrix(","").split(","):[1,1,1,1],o=parseFloat(s[0]),a=parseFloat(s[3]),r=(k(i,"border-left-width")+k(i,"border-right-width"))*o,h=(k(i,"border-top-width")+k(i,"border-bottom-width"))*a,c=(k(i,"padding-left")+k(i,"padding-right"))*o,l=(k(i,"padding-top")+k(i,"padding-bottom"))*a;return{scaleX:(n.width-r-c)/e.width,scaleY:(n.height-h-l)/e.height,offsetX:n.left+(k(i,"border-left-width")+k(i,"padding-left"))*o,offsetY:n.top+(k(i,"border-top-width")+k(i,"padding-top"))*a}}(n);t.type.includes("touch")?(Array.from(t.touches).map((({clientX:t,clientY:e,identifier:i})=>{let o=n.touches[i];o||(o=n.touches[i]={start:{x:(t-r)/s,y:(e-h)/a}},n.touches.length++),o.changed=!1})),Array.from(t.changedTouches).map((({clientX:i,clientY:c,identifier:l})=>{let d=n.touches[l];d.changed=!0,d.x=n.x=(i-r)/s,d.y=n.y=(c-h)/a,Y(n,e,t),o("touchChanged",t,n.touches),"onUp"==e&&(delete n.touches[l],n.touches.length--,n.touches.length||o("touchEnd"))}))):(n.x=(t.clientX-r)/s,n.y=(t.clientY-h)/a,Y(n,e,t))}function D(t){let e=t.canvas;t.clearRect(0,0,e.width,e.height)}let X=[],z={},W={},G={0:"south",1:"east",2:"west",3:"north",4:"leftshoulder",5:"rightshoulder",6:"lefttrigger",7:"righttrigger",8:"select",9:"start",10:"leftstick",11:"rightstick",12:"dpadup",13:"dpaddown",14:"dpadleft",15:"dpadright"};function O(t){X[t.gamepad.index]={pressedButtons:{},axes:{}}}function F(t){delete X[t.gamepad.index]}function U(){X.map((t=>{t.pressedButtons={},t.axes={}}))}function H(){let t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];for(let e=0;e<t.length;e++){let i=t[e];if(!i)continue;i.buttons.map(((t,e)=>{let n=G[e],{pressed:s}=t,{pressedButtons:o}=X[i.index],a=o[n];!a&&s?[z[i.index],z].map((e=>{e?.[n]?.(i,t)})):a&&!s&&[W[i.index],W].map((e=>{e?.[n]?.(i,t)})),o[n]=s}));let{axes:n}=X[i.index];n.leftstickx=i.axes[0],n.leftsticky=i.axes[1],n.rightstickx=i.axes[2],n.rightsticky=i.axes[3]}}function N(t,{gamepad:e}={}){return isNaN(e)?X.some((e=>e.pressedButtons[t])):!!X[e]&&!!X[e].pressedButtons[t]}let q={},$={},j={},V={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"arrowleft",ArrowUp:"arrowup",ArrowRight:"arrowright",ArrowDown:"arrowdown"};function K(e=t,i){e._pd&&i.preventDefault(),e(i)}function J(t){let e=V[t.code],i=q[e];j[e]=!0,K(i,t)}function Q(t){let e=V[t.code],i=$[e];j[e]=!1,K(i,t)}function Z(){j={}}function tt(t){return!!j[t]}function et(t){if(+t==t)return t;let e=[],i=t.split(".."),n=+i[0],s=+i[1],o=n;if(n<s)for(;o<=s;o++)e.push(o);else for(;o>=s;o--)e.push(o);return e}class it{constructor({image:t,frameWidth:e,frameHeight:i,frameMargin:n,animations:s}={}){if(!t)throw Error("You must provide an Image for the SpriteSheet");this.animations={},this.image=t,this.frame={width:e,height:i,margin:n},this._f=t.width/e|0,this.createAnimations(s)}createAnimations(t){let e,i;for(i in t){let{frames:n,frameRate:s,loop:o}=t[i];if(e=[],null==n)throw Error("Animation "+i+" must provide a frames property");[].concat(n).map((t=>{e=e.concat(et(t))})),this.animations[i]=l({spriteSheet:this,frames:e,frameRate:s,loop:o})}}}function nt(){return new it(...arguments)}const st=[[1,64,[[[0,5,58,10],[48,5,10,54],[4,49,44,10],[4,18,10,31],[4,18,40,10],[35,18,10,28],[17,36,18,10],[17,31,10,10]]],[5,10],[25,38],20,[],[]],[2,128,[[[0,59,48,10],[98,59,48,10]],[[80,59,48,10],[38,25,10,44],[10,25,29,10],[10,5,10,20],[10,5,80,10],[80,5,10,54]],[[98,59,30,10],[80,5,10,54],[57,49,23,10],[57,49,10,74],[57,113,51,10],[98,69,10,44]]],[5,64],[128,64],13,[[38,59],[80,49]],[]],[3,256,[[[0,231,24,10],[19,16,10,225],[19,16,207,10],[221,16,10,218],[53,229,178,10],[53,46,10,193],[53,46,136,10],[184,46,10,153],[88,194,106,10],[88,77,10,127],[88,77,67,10],[150,77,10,86],[119,158,41,10],[119,106,10,62]]],[5,236],[124,111],12,[],[[125,16],[125,229],[184,118]]],[4,128,[[[0,6,114,10],[108,6,10,33],[9,32,109,10],[9,38,10,30],[9,58,103,10],[108,58,10,32],[9,84,109,10],[9,91,10,26],[9,110,120,10],[9,21,10,24],[9,19,96,10],[19,45,99,10],[9,71,100,10],[19,97,99,10]],[[0,6,114,10],[108,6,10,36],[108,55,10,55],[9,84,96,10],[9,110,120,10],[9,19,10,23],[62,19,31,10],[9,71,96,10],[19,97,86,10],[95,19,10,26],[95,71,10,23],[95,45,23,10],[9,58,10,23],[19,32,15,10],[29,32,10,18],[29,45,26,10],[50,32,10,23],[50,32,24,10],[69,32,10,18],[19,58,71,10],[80,45,10,23],[69,45,21,10],[18,19,46,10],[83,19,10,18],[83,32,12,10]]],[5,11],[127,115],9,[[95,19],[19,84]],[[19,84]]],[5,128,[[[0,63,128,10],[28,28,10,35],[28,28,68,10],[91,28,10,70],[28,98,73,10],[28,68,10,40]],[[28,28,10,35],[28,28,68,10],[91,28,10,70],[28,98,73,10],[28,68,10,40],[-1,63,39,10],[91,63,36,10]]],[4,68],[127,68],10,[[60,63]],[]],[6,256,[[[0,6,114,10],[108,6,10,36],[108,55,10,55],[9,84,96,10],[9,110,120,10],[9,19,10,23],[62,19,31,10],[9,71,96,10],[19,97,86,10],[95,19,10,26],[95,71,10,23],[95,45,23,10],[9,58,10,23],[19,32,15,10],[29,32,10,18],[29,45,26,10],[50,32,10,23],[50,32,24,10],[69,32,10,18],[19,58,71,10],[80,45,10,23],[69,45,21,10],[18,19,46,10],[83,19,10,18],[83,32,12,10],[118,110,51,10],[159,110,10,23],[159,128,26,10],[180,128,10,25],[180,148,28,10],[203,148,10,27],[180,170,33,10],[180,170,10,26],[180,191,28,10],[203,191,10,31],[149,218,64,10],[149,205,10,22],[149,205,37,10],[159,138,10,15],[135,148,34,10],[135,148,10,89],[135,232,65,10],[159,157,10,44],[190,128,34,10],[218,128,10,58],[218,181,19,10],[232,128,10,64],[232,191,10,13],[217,199,25,10],[217,199,10,38],[197,232,30,10],[190,205,18,10],[19,71,10,17]],[[0,6,114,10],[108,6,10,36],[108,55,10,55],[9,84,96,10],[9,110,96,10],[9,19,10,23],[62,19,31,10],[9,71,96,10],[19,97,86,10],[95,19,10,26],[95,71,10,23],[95,45,23,10],[9,58,10,23],[19,32,15,10],[29,32,10,18],[29,45,26,10],[50,32,10,23],[50,32,24,10],[69,32,10,18],[19,58,71,10],[80,45,10,23],[69,45,21,10],[18,19,46,10],[83,19,10,18],[83,32,12,10],[108,110,51,10],[159,110,10,23],[159,128,31,10],[180,148,28,10],[203,148,10,27],[180,170,33,10],[180,170,10,26],[180,191,28,10],[203,191,10,31],[149,218,64,10],[149,205,10,22],[149,205,44,10],[159,138,10,15],[135,148,34,10],[135,148,10,66],[135,232,65,10],[159,157,10,44],[190,128,34,10],[218,128,10,58],[218,181,19,10],[232,128,10,64],[232,191,10,13],[217,199,25,10],[217,199,10,38],[197,232,30,10],[190,205,18,10],[19,71,10,17],[19,94,10,37],[19,126,22,10],[36,126,10,23],[18,144,28,10],[18,144,10,25],[18,164,40,10],[53,164,10,28],[53,187,26,10],[74,187,10,21],[33,203,51,10],[33,203,10,21],[33,218,116,10]]],[118,115],[195,210],150,[[159,120],[19,84]],[[19,84]]]];class ot{constructor(t){this.canvas=t,this.context=t.getContext("2d")}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t,e,i,n,s){this.context.drawImage(t,e,i,n,s)}drawText(t){this.context.font=t.font,this.context.fillStyle=t.color;let e=t.x;if(!t.left){let i=this.context.measureText(t.text).width;e=t.x-i/2}this.context.fillText(t.text,e,t.y)}drawFadingText(t){this.drawText({text:t.text,font:`${t.size}px Arial`,color:`rgba(255, 255, 255, ${t.opacity})`,x:t.position[0],y:t.position[1],left:t.left})}drawPlayerLight(t,e,i,n){let s=1.5*this.canvas.width*(1-n)<=3*i?3*i:1.5*this.canvas.width*(1-n),o=i+.1*this.canvas.width*(1-n),a=this.context.createRadialGradient(t,e,o,t,e,s);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(1,"rgba(0, 0, 0, 1)"),this.context.fillStyle=a,this.context.arc(t,e,2*this.canvas.width,0,2*Math.PI),this.context.fill()}drawEndPoint(t,e,i){let n=this.context.createRadialGradient(t,e,0,t,e,2*i);n.addColorStop(0,"rgba(1, 1, 1, 0)"),n.addColorStop(1,"rgba(1, 1, 1, 1)"),this.context.fillStyle=n,this.context.arc(t,e,i,0,2*Math.PI),this.context.fill()}drawYouLooseText(){let t=this.canvas.height/12+"px Arial",e=this.canvas.width/2,i=this.canvas.height/2;this.drawText({text:"Life was never for you...",font:t,color:"white",x:e,y:i})}drawYouWinText(){let t=this.canvas.height/12+"px Arial",e=this.canvas.width/2,i=this.canvas.height/2;this.drawText({text:"You win!",font:t,color:"white",x:e,y:i})}drawImage(t,e,i,n,s){this.context.drawImage(t,e,i,n,s)}drawButton(t){let e=t.x,i=t.y,n=t.text;this.context.fillStyle="#000",this.context.strokeStyle="#c8cdcc",this.context.font="24px Arial";let s=this.context.measureText(n).width+20,o=Math.floor(e-s/2)-10,a=Math.floor(i-17)-2;return this.context.fillRect(o,a,s,34),this.context.strokeRect(Math.floor(e-s/2)-10,Math.floor(i-17)-2,s,34),this.context.fillStyle="#c8cdcc",this.context.fillText(n,Math.floor(e-s/2),Math.floor(i+6)),{x:o,y:a,width:s,height:34}}setSize(t){this.canvas.width=t,this.canvas.height=t}}function at(t){return!!(tt(V.Space)||N("south")||N("start"))}function rt(t,e,i){const n=t.getPosition();let s=!1,o=!1;const a=n.x+e[0],r=n.y+e[1];for(let t=0;t<i.length;t++)s||a>i[t].x1&&a<=i[t].x1+i[t].width&&r>i[t].y1&&r<=i[t].y1+i[t].height&&(s=!0),o||n.x>i[t].x1-1&&n.x<i[t].x1+i[t].width+1&&n.y>i[t].y1-1&&n.y<i[t].y1+i[t].height+1&&(o=!0);return[s,o]}function ht(t,e){t.x+=e[0],t.y+=e[1]}class ct{constructor(){this.previousTime=(new Date).getTime()/1e3,this.timeElapsed=0,this.isRunning=!1}tick(){if(this.isRunning){let t=(new Date).getTime()/100;if(0!=Math.floor(t-this.previousTime))return this.timeElapsed+=.1,this.previousTime=t,!0}return!1}start(){this.previousTime=(new Date).getTime()/1e3,this.isRunning=!0}reset(){this.timeElapsed=0,this.isRunning=!1}}class lt{constructor(t,e,i,n=!1){this.position=t,this.text=e,this.size=i,this.opacity=1,this.left=n}reduceOpacity(t=1){this.opacity-=.01/t}reset(){this.opacity=1}}const dt=[new lt([256,200],'"We need help here stat"',20),new lt([75,100],'"Make room"',20),new lt([315,64],'"We\'re loosing him"',20),new lt([75,412],'"Come on"',20),new lt([356,378],'"Time of death..."',20)];function ut(...t){return pt.play(...t)}const pt={volume:.3,sampleRate:44100,x:new(window.AudioContext||webkitAudioContext),play:function(...t){return this.playSamples(this.buildSamples(...t))},playSamples:function(...t){const e=this.x.createBuffer(t.length,t[0].length,this.sampleRate),i=this.x.createBufferSource();return t.map(((t,i)=>e.getChannelData(i).set(t))),i.buffer=e,i.connect(this.x.destination),i.start(),i},buildSamples:function(t=1,e=.05,i=220,n=0,s=0,o=.1,a=0,r=1,h=0,c=0,l=0,d=0,u=0,p=0,f=0,g=0,w=0,m=1,x=0,y=0){const _=2*Math.PI;let v,M,b=this.sampleRate,E=h*=500*_/b/b,S=i*=(1+2*e*Math.random()-e)*_/b,A=[],P=0,R=0,k=0,C=1,T=0,L=0,I=0;for(c*=500*_/b**3,f*=_/b,l*=_/b,d*=b,u=u*b|0,M=(n=n*b+9)+(x*=b)+(s*=b)+(o*=b)+(w*=b)|0;k<M;A[k++]=I)++L%(100*g|0)||(I=a?a>1?a>2?a>3?Math.sin((P%_)**3):Math.max(Math.min(Math.tan(P),1),-1):1-(2*P/_%2+2)%2:1-4*Math.abs(Math.round(P/_)-P/_):Math.sin(P),I=(u?1-y+y*Math.sin(_*k/u):1)*(I>0?1:-1)*Math.abs(I)**r*t*this.volume*(k<n?k/n:k<n+x?1-(k-n)/x*(1-m):k<n+x+s?m:k<M-w?(M-k-w)/o*m:0),I=w?I/2+(w>k?0:(k<M-w?1:(M-k)/w)*A[k-w|0]/2):I),v=(i+=h+=c)*Math.cos(f*R++),P+=v-v*p*(1-1e9*(Math.sin(k)+1)%2),C&&++C>d&&(i+=l,S+=l,C=0),!u||++T%u||(i=S,h=E,C=C||1);return A},getNote:function(t=0,e=440){return e*2**(t/12)}},ft=[[[,0,400,.12,.16,,,,,,,,,.4,,,.26,,,.3],[.3,0,91,,.06,,4,2.4,,1.3,,,,5.3,,,.07,.3],[.3,0,44,,.8,,4,3.1,,1.3,,,,5.3,,,.07,.3],[.3,0,44,,.1,,4,3.1,,1.3,,,,5.3,,,.07,.3]],[[[,-.7,6,,,,,,,,6,,,,,,,,6,,,,,,17,,8,,,,13,,,,6,,,,,,,,6,,,,,,5,,6,,,,,,17,,8,,,,13,,,,],[1,.6,,,32,,,,,,,,32,,,,,,,,32,,,,,,,,32,,,,,,,,32,,,,,,,,32,,,,,,,,32,,,,,,,,32,,,,,,],[2,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,18,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[3,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,18,,]]],[0],90,{title:"song",instruments:["Lead","Perc 1","Perc 2","Perc 3"],patterns:["Pattern 0"]}],gt=(t=1,e=.05,i=220,n=0,s=0,o=.1,a=0,r=1,h=0,c=0,l=0,d=0,u=0,p=0,f=0,g=0,w=0,m=1,x=0,y=0)=>{let _,v,M=2*Math.PI,b=h*=500*M/mt**2,E=(0<f?1:-1)*M/4,S=i*=(1+2*e*Math.random()-e)*M/mt,A=[],P=0,R=0,k=0,C=1,T=0,L=0,I=0;for(c*=500*M/mt**3,f*=M/mt,l*=M/mt,d*=mt,u=mt*u|0,v=(n=99+mt*n)+(x*=mt)+(s*=mt)+(o*=mt)+(w*=mt)|0;k<v;A[k++]=I)++L%(100*g|0)||(I=a?1<a?2<a?3<a?Math.sin((P%M)**3):Math.max(Math.min(Math.tan(P),1),-1):1-(2*P/M%2+2)%2:1-4*Math.abs(Math.round(P/M)-P/M):Math.sin(P),I=(u?1-y+y*Math.sin(2*Math.PI*k/u):1)*(0<I?1:-1)*Math.abs(I)**r*t*wt*(k<n?k/n:k<n+x?1-(k-n)/x*(1-m):k<n+x+s?m:k<v-w?(v-k-w)/o*m:0),I=w?I/2+(w>k?0:(k<v-w?1:(v-k)/w)*A[k-w|0]/2):I),_=(i+=h+=c)*Math.sin(R*f-E),P+=_-_*p*(1-1e9*(Math.sin(k)+1)%2),R+=_-_*p*(1-1e9*(Math.sin(k)**2+1)%2),C&&++C>d&&(i+=l,S+=l,C=0),!u||++T%u||(i=S,h=b,C=C||1);return A},wt=.3,mt=44100,xt=new(top.AudioContext||webkitAudioContext);function yt(){const t=((...t)=>{let e=xt.createBufferSource(),i=xt.createBuffer(t.length,t[0].length,mt);return t.map(((t,e)=>i.getChannelData(e).set(t))),e.buffer=i,e.connect(xt.destination),e})(...((t,e,i,n=125)=>{let s,o,a,r,h,c,l,d,u,p,f,g,w,m,x,y,_=[],v=[],M=[],b=0,E=1,S={},A=mt/n*60>>2;for(;E;b++)_=[E=d=f=w=0],i.map(((n,f)=>{for(l=e[n][b]||[0,0,0],E|=!!e[n][b],x=w+(e[n][0].length-2-!d)*A,o=2,r=w;o<l.length+(f==i.length-1);d=++o){for(h=l[o],u=p!=(l[0]||0)|h|0,a=0;a<A&&d;a++>A-99&&u?g+=(g<1)/99:0)c=(1-g)*_[m++]/2||0,v[r]=(v[r]||0)+c*y-c,M[r]=(M[r++]||0)+c*y+c;h&&(g=h%1,y=l[1]||0,(h|=0)&&(_=S[[p=l[m=0]||0,h]]=S[[p,h]]||(s=[...t[p]],s[2]*=2**((h-12)/12),gt(...s))))}w=x}));return[v,M]})(...ft));return t.loop=!0,t.start(),t}class _t{constructor(t){this.spriteSheet=new nt({image:t,frameWidth:16,frameHeight:16,animations:{idle:{frames:"0..3",frameRate:5},death:{frames:"3..7",frameRate:5,loop:!1},gem:{frames:"8",frameRate:5},gemDeath:{frames:"9..12",frameRate:20,loop:!1}}})}getPlayer(){const t=b({x:0,y:0,rad:4,animations:this.spriteSheet.animations,speed:1,getPosition:function(){return{x:this.x+8,y:this.y+8}},setPosition:function(t,e){this.x=t-8,this.y=e-8}});return t.playAnimation("idle"),t}getGem(t){const e=new b({x:t[0]-3,y:t[1]-3,animations:this.spriteSheet.animations});return e.playAnimation("gem"),e}getExplodingGem(t){const e=new b({x:t[0]-3,y:t[1]-3,animations:this.spriteSheet.animations,startTime:(new Date).getTime(),animationOver:function(){return(new Date).getTime()-this.startTime>200}});return e.playAnimation("gemDeath"),e}}class vt{constructor(t,e,i){this.x=t,this.y=e,this.text=i,this.active=!1}toggle(){this.active=!this.active}}const Mt=[{dialog:[{text:"5 October 1984",color:"white"}],time:.1},{dialog:[{text:'"Flight 815 requsting permission to land"',color:"red"}],time:5},{dialog:[{text:'"Control tower here. Can you see the runway?"',color:"blue"},{text:'"No. I have no view."',color:"red"},{text:'"Drop 2,000 feet and keep contact."',color:"blue"},{text:'"Roger."',color:"red"}],time:10},{dialog:[{text:'"Can you see the runway?"',color:"blue"},{text:'"No. Still no sight."',color:"red"},{text:'"Wind is changing. Approach runway 5 from west instead."',color:"blue"},{text:'"Roger."',color:"red"}],time:15},{dialog:[{text:'"Captain! We need to pull up and abort the landing."',color:"yellow"},{text:'"Wait one moment."',color:"red"},{text:"\"Don't see, don't see, captian! Turn back!\"",color:"yellow"}],time:20},{dialog:[{text:"*crash*",color:"white"}],time:25},{dialog:[{text:"Later...",color:"white"}],time:30},{dialog:[{text:"*burning sound*",color:"white"}],time:35},{dialog:[{text:'"Help! There is a boy here. HE IS ALIVE!"',color:"purple"}],time:40},{dialog:[{text:'We need to get him to the hospital"',color:"purple"},{text:"Hold on! I'll get my bike\"",color:"green"},{text:'HURRY!!!"',color:"purple"}],time:45},{dialog:[{text:'"Hold on to him. Let\'s go!"',color:"green"}],time:50},{dialog:[{text:"",color:"green"}],time:55}];class bt{constructor(t,e,i,n){this.x1=t,this.x2=t+i,this.y1=e,this.y2=e+n,this.width=i,this.height=n}}class Et{constructor(t,e,i,n,s,o,a=[],r=[]){this.name=t,this.size=e,this.startPoint=n,this.endPoint=s,this.time=o,this.switches=a,this.gems=r,this.map=this.setUpMap(i)}setUpMap(t){const e=[];return t.forEach((t=>{const i=[];t.forEach((t=>{i.push(new bt(t[0],t[1],t[2],t[3]))})),e.push(i)})),e}draw(t,e,i){t.clear(),t.width=this.size,t.height=this.size;const n=t.context;this.map[i].forEach((t=>{if(t.width>=t.height){for(let i=0;i<Math.floor(t.width/10);i++)n.drawImage(e,t.x1+10*i,t.y1,10,10);t.width%10!=0&&n.drawImage(e,t.x1+10*Math.floor(t.width/10),t.y1,t.width%10,10)}else{for(let i=0;i<Math.floor(t.height/10);i++)n.drawImage(e,t.x1,t.y1+10*i,10,10);t.height%10!=0&&n.drawImage(e,t.x1,t.y1+10*Math.floor(t.height/10),10,t.height%10)}})),n.fillStyle="grey",n.fill()}delete(t,e){"switches"===t&&this.switches.splice(e,1),"gems"===t&&this.gems.splice(e,1)}}class St{constructor(t,e,i,n,s){this.text=t,this.x=e,this.y=i,this.size=n,this.color=s,this.font=`${n}px Arial`}}let{canvas:At,context:Pt}=function(t,{contextless:n=!1}={}){if(e=document.getElementById(t)||t||document.querySelector("canvas"),n&&(e=e||new Proxy({},a)),!e)throw Error("You must provide a canvas element for the game");return i=e.getContext("2d")||new Proxy({},a),i.imageSmoothingEnabled=!1,o("init"),{canvas:e,context:i}}(document.getElementById("kontra"));At.style.backgroundColor="rgba(0, 0, 0, 0)",Tt(At);const Rt=new ot(document.getElementById("background"));Tt(Rt.canvas);const kt=new ot(document.getElementById("text-layer"));Tt(kt.canvas);const Ct=new ot(document.getElementById("light-layer"));function Tt(t){let e=(window.innerWidth-document.getElementById("text-layer").offsetWidth)/2;t.style.left=e+"px"}Tt(Ct.canvas),f="./assets/",function(){let t;for(t=0;t<26;t++)V["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)V["Digit"+t]=V["Numpad"+t]=""+t;window.addEventListener("keydown",J),window.addEventListener("keyup",Q),window.addEventListener("blur",Z)}(),window.addEventListener("gamepadconnected",O),window.addEventListener("gamepaddisconnected",F),window.addEventListener("blur",U),s("tick",H),function({radius:t=5,canvas:e=r()}={}){let i=E.get(e);if(!i){let n=window.getComputedStyle(e);i={x:0,y:0,radius:t,touches:{length:0},canvas:e,_cf:[],_lf:[],_o:[],_oo:null,_s:n},E.set(e,i)}e.addEventListener("mousedown",C),e.addEventListener("touchstart",C),e.addEventListener("mouseup",T),e.addEventListener("touchend",T),e.addEventListener("touchcancel",T),e.addEventListener("blur",I),e.addEventListener("mousemove",L),e.addEventListener("touchmove",L),i._t||(i._t=!0,s("tick",(()=>{i._lf.length=0,i._cf.map((t=>{i._lf.push(t)})),i._cf.length=0})))}(),function(){const t=[x("full-sheet.png"),x("floor-export.png"),x("splash.png")];return Promise.all(t)}().then((e=>{let i,n,s=null,a=0,r=0,c=0,l=st.length,d=[],u=[];const p=[];let f=0,g=new _t(e[0]);const w=g.getPlayer(),m=e[1],x=e[2];let y;const _=new ct,v=new ct,M=new ct,b=[];let E=0,S=!1,P=!1,R=0,k=!1,C=!1,T=function({fps:e=60,clearCanvas:i=!0,update:n=t,render:s,context:a=h(),blur:r=!1}={}){if(!s)throw Error("You must provide a render() function");let c,l,d,u,p,f=0,g=1e3/e,w=1/e,m=i?D:t,x=!0;function y(){if(l=requestAnimationFrame(y),x&&(d=performance.now(),u=d-c,c=d,!(u>1e3))){for(o("tick"),f+=u;f>=g;)p.update(w),f-=g;m(a),p.render()}}return r||(window.addEventListener("focus",(()=>{x=!0})),window.addEventListener("blur",(()=>{x=!1}))),p={update:n,render:s,isStopped:!0,start(){c=performance.now(),this.isStopped=!1,requestAnimationFrame(y)},stop(){this.isStopped=!0,cancelAnimationFrame(l)},_frame:y,set _last(t){c=t}},p}({update:function(){if(!!A["left"]&&console.log("hej!"),1==a&&at()&&(L(),a=2,B(w),X(m)),2==a){if(_.tick()){let t=Math.round(10*_.timeElapsed)/10;t==f-5&&(P=!0,v.start()),t==f&&(a=3,C=!0,w.playAnimation("death"),S=!0)}(function(t,e){const i=t.getPosition(),n=t.rad;return i.x+n>=e[0]-3&&i.x-n<=e[0]+3&&i.y+n>=e[1]-3&&i.y-n<=e[1]+3})(w,n.endPoint)&&(r++,r>=l?(r=0,c=0,k=!0,a=5,_.reset()):(ut(...[.5,,632,.02,.09,.54,3,1.43,,.2,,,,1.8,,.9,,.34,.02]),B(w),X(m))),u.forEach(((t,e)=>{(function(t,e){const i=t.getPosition();return i.x>e[0]&&i.x<e[0]+12&&i.y>e[1]&&i.y<e[1]+12})(w,t)&&(u.splice(e,1),c<n.map.length-1?c++:c=0,X(m))})),d.forEach(((t,e)=>{(function(t,e){const i=t.getPosition();return i.x+t.rad>=e[0]+2-4&&i.x-t.rad<=e[0]+2+4&&i.y+t.rad>=e[1]+2-4&&i.y-t.rad<=e[1]+2+4})(w,[t.x,t.y])&&(d.splice(e,1),p.push(g.getExplodingGem([t.x+2,t.y+2])),_.reset(),_.start(),P=!1,v.reset(),Y(),ut(...[.4,,1842,,.03,.2,,.27,2.7,,,,,.1,,,,.52,.04,.19]))})),p.length>0&&p.forEach(((t,e)=>{t.update(),t.animationOver()&&p.splice(e,1)})),function(t,e){const i=[0,0];document.onclick=()=>{var n=event.clientX,s=event.clientY;s/=10,(n=(n-700)/10)>=t.position._x?i[0]+=2:i[0]-=2,s>=t.position._y?i[1]+=2:i[1]-=2;const o=rt(t,i,e);return o[0]&&ht(t,i),o[1]},(tt(V.ArrowDown)||tt("s")||N("dpaddown"))&&(i[1]+=1),(tt(V.ArrowUp)||tt("w")||N("dpadup"))&&(i[1]-=1),(tt(V.ArrowLeft)||tt("a")||N("dpadleft"))&&(i[0]-=1),(tt(V.ArrowRight)||tt("d")||N("dpadright"))&&(i[0]+=1);const n=rt(t,i,e);return n[0]&&ht(t,i),n[1]}(w,n.map[c])||k||(a=3,C=!0,w.playAnimation("death"),S=!0),w.update()}3==a&&(E++,60==E&&(E=0,a=4),w.update())},render:function(){0==a&&(Rt.setSize(128),kt.clear(),M.isRunning||M.start(),function(){M.tick();let t=Math.round(10*M.timeElapsed)/10;Mt[0].time==t&&(b.splice(0,b.length),Mt[0].dialog.forEach((t=>{b.push(new St(t.text,256,240+26*b.length,16,t.color))})),Mt.splice(0,1)),b.forEach(((t,e)=>{kt.drawText(t)})),0==Mt.length&&(a=1)}(),at()&&(a=1)),1==a&&(kt.clear(),Rt.setSize(128),Rt.clear(),Rt.context.rect(0,0,128,128),Rt.context.fillStyle="#000",Rt.context.fill(),Rt.context.drawImage(x,14,16),s=kt.drawButton(new vt(256,350,"Start"))),2==a&&(function(t,e){let i=t.createRadialGradient(e[0],e[1],0,e[0],e[1],10);i.addColorStop(0,"rgba(255, 255, 255, 1)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),t.beginPath(),t.arc(e[0],e[1],10,0,2*Math.PI),t.fillStyle=i,t.fill()}(Pt,n.endPoint),kt.clear(),Ct.clear(),function(){let t=R*(_.timeElapsed+1)<=1?R*(_.timeElapsed+1):1;Ct.drawPlayerLight(w.x+2*w.rad,w.y+2*w.rad,w.rad,t)}(),d.forEach((t=>{t.render()})),p.length>0&&p.forEach((t=>{t.render()})),w.render(),y.opacity&&(kt.drawFadingText(y),y.reduceOpacity()),P&&(v.tick(),dt.forEach(((t,e)=>{e<=v.timeElapsed&&t.opacity>0&&(kt.drawFadingText(t),t.reduceOpacity())})))),3==a&&(w.render(),Ct.clear(),Rt.clear()),4==a&&(Rt.clear(),kt.clear(),kt.drawYouLooseText(),kt.drawButton(new vt(256,350,"Retry")),at()&&(L(),a=2,B(w),w.playAnimation("idle"),X(m)),I()),5==a&&(Rt.clear(),kt.clear(),kt.drawYouWinText(),I())}});function L(){i||(i=new yt)}function I(){i&&i.stop()}function Y(){dt.forEach((t=>{t.reset()}))}function B(t){n=new Et(...st[r]),f=n.time,R=1/(f-3),t.setPosition(n.startPoint[0],n.startPoint[1]),Rt.setSize(n.size),Ct.setSize(n.size),At.width=n.size,At.height=n.size,u=[],d=[],n.gems.forEach((t=>{d.push(g.getGem(t))})),n.switches.forEach((t=>{u.push(t)})),c=0,_.reset(),_.start(),v.reset(),P=!1,Y(),y=new lt([256,256],"Level "+n.name,50)}function X(t){r<=l&&n.draw(Rt,t,c)}T.start()}))})();